def javaProjects() {
  subprojects.findAll { new File(it.projectDir, 'src').directory }
}

allprojects {
  group = 'org.jfrog.test.gradle.publish'
  version = currentVersion
  status = 'Integration'
  repositories {
    maven {
      url "${System.env.BITESTS_ARTIFACTORY_URL}/${System.env.BITESTS_ARTIFACTORY_VIRTUAL_REPO}"
      credentials {
        username "${System.env.BITESTS_ARTIFACTORY_USERNAME}"
        password "${System.env.BITESTS_ARTIFACTORY_PASSWORD}"
      }
    }
  }
}

artifactoryPublish.skip = true

project('services') {
  artifactoryPublish.skip = true
}

configure(javaProjects()) {
  apply plugin: 'java'
  apply plugin: 'maven-publish'

  dependencies {
    testImplementation 'junit:junit:4.7'
  }

  publishing {
    publications {
      mavenJava(MavenPublication) {
        from components.java
        artifact(file("$rootDir/gradle.properties"))
      }
    }
  }
}

project('api') {
  apply plugin: 'ivy-publish'

  publishing {
    publications {
      ivyJava(IvyPublication) {
        from components.java
        // The config below will add a extra attribute to the ivy.xml
        // See http://ant.apache.org/ivy/history/latest-milestone/concept.html#extra
        descriptor.withXml {
          asNode().info[0].attributes().put('e:architecture', 'amd64')
        }
      }
    }
  }
}
